<!doctype html>
<html>
  <head>
    <style>
    html,
    body {
      height: 100%;
      overflow: hidden;
    }
    body { /* can also be whatever container */
      display: flex;
      display: -webkit-flex;
      display: flex;
      -webkit-align-items: center;
      align-items: center;
      -webkit-justify-content: center;
      justify-content: center;
    }
    #status_div{
      font-family: sans-serif;
      padding: 0px;
      font-size: 3.2rem;
      font-weight: 700;
      font-family: sans-serif;
    }
    #startbutton{border-radius:7px;padding:24px;font-size:18px;background:transparent;box-shadow: 0px 0px 8px #5555AA; color:#555}
    </style>
    <script src="js/multipart.js"></script>
    <script src="js/audioRecorder.js"></script>
    <script src="js/callbackManager.js"></script>
    <script src="js/avsaurus.js"></script>
  </head>
  <body>
    <button id="startbutton">Start</button>
    <script>

    // AVSaurus
    function startAvsaurus(token){
      if(window.avs){
        return window.avs.setAccessToken(token)
      }
      var avs = window.avs = new AVSaurus({
        'wakewords':[{
          id:'LEXIE',
          pronounce: 'L EH K S IY' // from http://www.speech.cs.cmu.edu/cgi-bin/cmudict
        }],
        'wakewordSensitivity':"1e-20"
      })
      avs.setAccessToken(token)

      // DOM stuff
      avs.on('ready', function(){
        if(!this.statusDiv){
          var dv = document.createElement('div')
          dv.id = 'status_div'
          this.statusDiv = dv
          document.body.appendChild(dv)
        }
        this.sound(87.31, 'sine')
        this.statusDiv.innerHTML = 'I\'m listening... (say: <i>Lexie, tell me a joke.</i>)'
      })

      avs.on('wakeword', function(){
        this.sound(440.0, 'sine')
        this.statusDiv.innerHTML = 'You called?'
      })

      avs.on('sending', function(){
        this.statusDiv.innerHTML = 'Asking Lexie...'
      })

      avs.on('talking', function(){
        this.statusDiv.innerHTML = 'talking...'
      })

      avs.on('token_expired', function(){
        loadAmazonLogin()
      })

      avs.on('replyobject', function(obj){
        if(obj && obj.messageBody && obj.messageBody.directives){
          let ds = obj.messageBody.directives
          for(let i=0;i<ds.length; i++){
            if(ds[i].name == "RenderTemplate"){
              this.statusDiv.innerHTML = `
              <div style="font-size: 1.4rem;padding:0px 30px 0px 30px;">
              <h1><img style="width:40px;" src="${ds[i].payload.skillIcon.sources[0].url}"/>&nbsp;${ds[i].payload.title.mainTitle}</h1>
              <p>${ds[i].payload.textField.replace(/\n/g, '<br/>')}</p>
              </div>
              `
            }
          }
        }
      })

      /**
       * Some browsers (like Safari) won't allow sounds to play
       * if it isn't triggered by an onclick event
       * @param  {Function} onclickFunction function to call during onclick event
       * @return {undefined}
       */
      avs.on('click_confirm', function(onclickFunction){
        var dv = document.createElement('button')
        dv.id = 'confirm_play_btn'
        dv.style.left = '10px'
        dv.innerHTML = 'Play the response'
        dv.onclick = function(){
          dv.parentNode.removeChild(dv)
          onclickFunction()
        }
        document.body.appendChild(dv)
      })

    }

    </script>


    
    <div id="amazon-root"></div>
    <script type="text/javascript">

      var clientID = 'amzn1.application-oa2-client.49e731244394490ab92c260cfd8131e2'
      var productID = 'AVSaurus'

      window.onAmazonLoginReady = function() {
        amazon.Login.setClientId(clientID);
        var deviceId = localStorage.getItem('alexa_deviceId')
        if(!deviceId){
          deviceId = (Math.random() +'').substring(2)
          localStorage.setItem('alexa_deviceId', deviceId)
        }
        var options = {
          pkce: true,
          scope : 'alexa:all',
          scope_data:{
            'alexa:all':{
              "productID" : productID,
              "productInstanceAttributes": { "deviceSerialNumber" : deviceId }
            }
          },
          popup: true
        };
        let b = document.getElementById('startbutton')
        b.addEventListener('click', (ev)=>{
          b.style.display = 'none'

          let tokenKey = 'alexa_atoken'
          let accessToken = localStorage.getItem(tokenKey)
          if(accessToken){
            startAvsaurus(accessToken)
          }else{
            amazon.Login.authorize(options, function(response) {
              if ( response.error ) {
                localStorage.removeItem(tokenKey)
                console.log('oauth error ' + response.error);
                b.style.display = 'inline'
                return;
              }
              amazon.Login.retrieveToken(response.code, function(response) {
                if ( response.error ) {
                  localStorage.removeItem(tokenKey)
                  console.log('oauth error ' + response.error);
                  b.style.display = 'inline'
                  return;
                }
                localStorage.setItem(tokenKey, response.access_token)
                startAvsaurus(response.access_token)
              });
            });
          }
        })
      };
      (function(d) {
        var a = d.createElement('script'); a.type = 'text/javascript';
        a.async = true; a.id = 'amazon-login-sdk';
        a.src = 'https://assets.loginwithamazon.com/sdk/na/login1.js';
        d.getElementById('amazon-root').appendChild(a);
      })(document);
    </script>
    
  </body>
</html>
